# CAS - ë™ê¸°í™”ì™€ ì›ìì  ì—°ì‚°<br/><br/><br/># ğŸ’¡ì›ìì  ì—°ì‚°> **ì›ìì  ì—°ì‚°**(`atomic operation`): **í•´ë‹¹ ì—°ì‚°ì´ ë” ì´ìƒ ë‚˜ëˆŒ ìˆ˜ ì—†ëŠ” ë‹¨ìœ„ë¡œ ìˆ˜í–‰ëœë‹¤**ëŠ” ê²ƒì„ ì˜ë¯¸`i = 1;`- ìœ„ì˜ ì—°ì‚°ì€ ë‘˜ë¡œ ìª¼ê°¤ ìˆ˜ ì—†ëŠ” `ì›ìì  ì—°ì‚°`ì´ë‹¤.- **ë‹¨ í•˜ë‚˜ì˜ ìˆœì„œë¡œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì´ë‹¤.**`i = i + 1;`- ìœ„ì˜ ì—°ì‚°ì€ **`ì›ìì  ì—°ì‚°`ì´ ì•„ë‹ˆë‹¤.**1. ì˜¤ë¥¸ìª½ì— ìˆëŠ” `i` ì˜ ê°’ì„ ì½ëŠ”ë‹¤. `i` ì˜ ê°’ì€ 1 ì´ë‹¤.2. ì½ì€ 1ì— 1ì„ ë”í•´ì„œ 2ë¥¼ ë§Œë“ ë‹¤.3. ë”í•œ 2ì„ ì™¼ìª½ì˜ `i` ë³€ìˆ˜ì— ëŒ€ì…í•œë‹¤.`i++;`- **ì›ìì  ì—°ì‚°ì´ ì•„ë‹ˆë‹¤.**- `i = i + 1` ì„ ì¶•ì•½í•œ ê²ƒ> **ì›ìì  ì—°ì‚°ì€ ë©€í‹°ìŠ¤ë ˆë“œ ìƒí™©ì—ì„œ ì•„ë¬´ëŸ° ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.      > í•˜ì§€ë§Œ ì›ìì  ì—°ì‚°ì´ ì•„ë‹Œ ê²½ìš°ì—ëŠ” `synchronized` ë¸”ëŸ­ì´ë‚˜ `Lock` ë“±ì„ ì‚¬ìš©í•´ì„œ ì•ˆì „í•œ ì„ê³„ ì˜ì—­ì„ ë§Œë“¤ì–´ì•¼ í•œë‹¤.**<br/><br/><br/># ğŸ’¡ ì›ìì  ì—°ì‚° ì˜ˆì‹œ ì½”ë“œ - int, volatile, synchronized, AtomicInteger> **ì›ìì ì´ì§€ ì•Šì€ ì—°ì‚°ì„ ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ì‹¤í–‰í•˜ë©´ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤!!!**```javapublic interface IncrementInteger {     void increment();     int get();}```- `IncrementInteger` ëŠ” ìˆ«ì ê°’ì„ í•˜ë‚˜ì”© ì¦ê°€ì‹œí‚¤ëŠ” ê¸°ëŠ¥ì„ ì œê³µ<br/><br/>## âš¡ï¸ <u>**ê¸°ë³¸ì ì¸ int**</u>```javapublic class BasicInteger implements IncrementInteger{    private int value;    @Override    public void increment() {        value++;    }    @Override    public int get() {        return value;    }}```- `value` ê°’ì€ `ì¸ìŠ¤í„´ìŠ¤ì˜ í•„ë“œ`ì´ê¸° ë•Œë¬¸ì—, ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ê³µìœ í•  ìˆ˜ ìˆë‹¤. - ì´ë ‡ê²Œ `ê³µìœ  ê°€ëŠ¥í•œ ìì›`ì— `++` ì™€ ê°™ì€ `ì›ìì ì´ì§€ ì•Šì€ ì—°ì‚°`ì„ ì‚¬ìš©í•˜ë©´ **ë©€í‹°ìŠ¤ë ˆë“œ ìƒí™©ì— ë¬¸ì œê°€ ë  ìˆ˜ ìˆë‹¤.**```javapackage thread.cas.increment;import static util.ThreadUtils.sleep;import java.util.ArrayList;import java.util.List;public class IncrementThreadMain {    public static final int THREAD_COUNT = 1000;    public static void main(String[] args) throws InterruptedException {        test(new BasicInteger());//        test(new VolatileInteger());//        test(new SyncInteger());//        test(new MyAtomicInteger());//        test(new ReentrantLockInteger());    }    private static void test(IncrementInteger incrementInteger) throws InterruptedException {        Runnable runnable = new Runnable() {            @Override            public void run() {                sleep(50); //ë„ˆë¬´ ë¹¨ë¦¬ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì—, ë‹¤ë¥¸ ìŠ¤ë ˆë“œì™€ ë™ì‹œ ì‹¤í–‰ì„ ìœ„í•´ ì ê¹ ì‰¬ì—ˆë‹¤ê°€ ì‹¤í–‰                incrementInteger.increment();            }        };        List<Thread> threads = new ArrayList<>();        for (int i = 0; i < THREAD_COUNT; i++) {            Thread thread = new Thread(runnable);            threads.add(thread);            thread.start();        }        for (Thread thread : threads) {            thread.join();        }        int result = incrementInteger.get();        System.out.println(incrementInteger.getClass().getSimpleName() + " result:" + result);    }}```<br/><br/>## âš¡ï¸ <u>**volatile**</u>```javapackage thread.cas.increment;public class VolatileInteger implements IncrementInteger{    private volatile int value;    @Override    public void increment() {        value++;    }    @Override    public int get() {        return value;    }}```- `volatile` ì€ ì—¬ëŸ¬ CPU ì‚¬ì´ì— ë°œìƒí•˜ëŠ” ìºì‹œ ë©”ëª¨ë¦¬ì™€ ë©”ì¸ ë©”ëª¨ë¦¬ê°€ ë™ê¸°í™” ë˜ì§€ ì•ŠëŠ” ë¬¸ì œë¥¼ í•´ê²°í•  ë¿ì´ë‹¤.- ìºì‹œ ë©”ëª¨ë¦¬ê°€ ì˜í–¥ì„ ì¤„ ìˆ˜ëŠ” ìˆì§€ë§Œ, ìºì‹œ ë©”ëª¨ë¦¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ , ë©”ì¸ ë©”ëª¨ë¦¬ë¥¼ ì§ì ‘ ì‚¬ìš©í•´ë„ ì—¬ì „íˆ ë°œìƒí•˜ëŠ” ë¬¸ì œì´ë‹¤. - **ì´ ë¬¸ì œëŠ” ì—°ì‚° ìì²´ê°€ ë‚˜ëˆ„ì–´ì ¸ ìˆê¸° ë•Œë¬¸ì— ë°œìƒí•œë‹¤.**<br/><br/>## âš¡ï¸ <u>**synchronized**</u>```javapublic class SyncInteger implements IncrementInteger{    private int value;    @Override    public synchronized void increment() {        value++;    }    @Override    public synchronized int get() {        return value;    }}```- `synchronized` ë¥¼ ì ìš©í•´ì„œ `ì•ˆì „í•œ ì„ê³„ ì˜ì—­(critical section)`ì„ ë§Œë“ ë‹¤.- `value++;` ì—°ì‚°ì„ í•œ ë²ˆì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ì‹¤í–‰í•˜ë„ë¡ ë³´ì¥í•œë‹¤.<br/><br/>## âš¡ï¸ <u>**AtomicInteger - ì›ìì  ì—°ì‚°**</u>```javapublic class MyAtomicInteger implements IncrementInteger{    private AtomicInteger value = new AtomicInteger(0);    @Override    public void increment() {        value.incrementAndGet();    }    @Override    public int get() {        return value.get();    }}```- **`AtomicInteger` ëŠ” ë©€í‹°ìŠ¤ë ˆë“œ ìƒí™©ì— ì•ˆì „í•˜ê³  ë˜ ë‹¤ì–‘í•œ ê°’ ì¦ê°€, ê°ì†Œ ì—°ì‚°ì„ ì œê³µí•œë‹¤.** - íŠ¹ì • ê°’ì„ ì¦ê°€í•˜ê±°ë‚˜ ê°ì†Œí•´ì•¼ í•˜ëŠ”ë° ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ í•´ë‹¹ ê°’ì„ ê³µìœ í•´ì•¼ í•œë‹¤ë©´, `AtomicInteger` ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.<br/><br/>## âš¡ï¸ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸```> Task :IncrementPerformanceMain.main()BasicInteger: ms=5VolatileInteger: ms=179SyncInteger: ms=357MyAtomicInteger: ms=190ReentrantLockInteger: ms=499```### ğŸ”‹ **BasicInteger** - **ê°€ì¥ ë¹ ë¥´ë‹¤.**- ***`CPU ìºì‹œ`ë¥¼ ì ê·¹ ì‚¬ìš©í•œë‹¤. CPU ìºì‹œì˜ ìœ„ë ¥ì„ ì•Œ ìˆ˜ ìˆë‹¤.***- ì•ˆì „í•œ ì„ê³„ ì˜ì—­ë„ ì—†ê³ , `volatile` ë„ ì‚¬ìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë©€í‹°ìŠ¤ë ˆë“œ ìƒí™©ì—ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤. - ë‹¨ì¼ ìŠ¤ë ˆë“œê°€ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì— íš¨ìœ¨ì ì´ë‹¤.### ğŸ”‹ **VolatileInteger**- **`volatile` ì„ ì‚¬ìš©í•´ì„œ CPU ìºì‹œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  `ë©”ì¸ ë©”ëª¨ë¦¬ë¥¼ ì‚¬ìš©`í•œë‹¤.**- ì•ˆì „í•œ ì„ê³„ ì˜ì—­ì´ ì—†ê¸° ë•Œë¬¸ì— **ë©€í‹°ìŠ¤ë ˆë“œ ìƒí™©ì—ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.**- ë‹¨ì¼ ìŠ¤ë ˆë“œê°€ ì‚¬ìš©í•˜ê¸°ì—ëŠ” `BasicInteger` ë³´ë‹¤ ëŠë¦¬ë‹¤. ê·¸ë¦¬ê³  ë©€í‹°ìŠ¤ë ˆë“œ ìƒí™©ì—ë„ ì•ˆì „í•˜ì§€ ì•Šë‹¤.### ğŸ”‹ **SyncInteger**- `synchronized` ë¥¼ ì‚¬ìš©í•œ `ì•ˆì „í•œ ì„ê³„ ì˜ì—­`ì´ ìˆê¸° ë•Œë¬¸ì— **ë©€í‹°ìŠ¤ë ˆë“œ ìƒí™©ì—ë„ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.** - `MyAtomicInteger` ë³´ë‹¤ ì„±ëŠ¥ì´ ëŠë¦¬ë‹¤.### ğŸ”‹ **MyAtomicInteger**- ìë°”ê°€ ì œê³µí•˜ëŠ” `AtomicInteger` ë¥¼ ì‚¬ìš©í•œë‹¤. ë©€í‹°ìŠ¤ë ˆë“œ ìƒí™©ì— ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. - **ì„±ëŠ¥ë„ `synchronized` , `Lock(ReentrantLock)` ì„ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ë³´ë‹¤ `1.5 ~ 2ë°° ì •ë„ ë¹ ë¥´ë‹¤.`**> ***`AtomicInteger` ê°€ ì œê³µí•˜ëŠ” `incrementAndGet()` ë©”ì„œë“œëŠ” `ë½(lock)ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³ `, ì›ìì  ì—°ì‚°ì„ ë§Œë“¤ì–´ë‚¸ë‹¤.***<br/><br/><br/># ğŸ’¡ CAS ì—°ì‚° - Compare And Swap`ë½(lock)`ì€- íŠ¹ì • ìì›ì„ ë³´í˜¸í•˜ê¸° ìœ„í•´ ìŠ¤ë ˆë“œê°€ í•´ë‹¹ ìì›ì— ëŒ€í•œ ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ì œí•œí•œë‹¤.- ë½ì´ ê±¸ë ¤ ìˆëŠ” ë™ì•ˆ **ë‹¤ë¥¸ ìŠ¤ë ˆë“œë“¤**ì€ `í•´ë‹¹ ìì›ì— ì ‘ê·¼í•  ìˆ˜ ì—†ê³ `, `ë½ì´ í•´ì œë  ë•Œê¹Œì§€ ëŒ€ê¸°`í•´ì•¼ í•œë‹¤.1. ë½ì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.2. ë½ì„ íšë“í•˜ê³  ì„ê³„ ì˜ì—­ì— ë“¤ì–´ê°„ë‹¤.3. ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤.4. ë½ì„ ë°˜ë‚©í•œë‹¤.> `ë½(lock)`ì€ **10000ë²ˆì˜ ì—°ì‚°ì´ ìˆë‹¤ë©´ ëª¨ë‘ ìœ„ì™€ ê°™ì€ ê³¼ì •ì„ ë°˜ë³µí•´ì•¼ í•˜ê¸° ë•Œë¬¸ì—, ë½ì„ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì€ ì§ê´€ì ì´ì§€ë§Œ ìƒëŒ€ì ìœ¼ë¡œ ë¬´ê±°ìš´ ë°©ì‹ì´ë‹¤.**---<u>**`CAS(Compare-And-Swap, Compare-And-Set)` ì—°ì‚°**</u>ì€- **ë½ì„ ê±¸ì§€ ì•Šê³  ì›ìì ì¸ ì—°ì‚°**ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ë°©ë²•      - ë½ í”„ë¦¬(lock-free) ê¸°ë²•- CAS ì—°ì‚°ì€ ë½ì„ ì™„ì „íˆ ëŒ€ì²´í•˜ëŠ” ê²ƒì€ ì•„ë‹ˆê³ , **ì‘ì€ ë‹¨ìœ„ì˜ ì¼ë¶€ ì˜ì—­ì— ì ìš©**í•  ìˆ˜ ìˆë‹¤. - **ê¸°ë³¸ì€ ë½ì„ ì‚¬ìš©í•˜ê³ , íŠ¹ë³„í•œ ê²½ìš°ì— CASë¥¼ ì ìš©í•  ìˆ˜ ìˆë‹¤ê³  ìƒê°í•˜ë©´ ëœë‹¤.**`AtomicInteger atomicInteger = new AtomicInteger(0);`     `atomicInteger.compareAndSet(0, 1);`- ë§Œì•½ `atomicInteger` ì˜ ê°’ì´ í˜„ì¬ 0ì´ë¼ë©´ `atomicInteger` ì˜ ê°’ì€ 1ë¡œ ë³€ê²½ëœë‹¤. ì´ ê²½ìš° `true` ë¥¼ ë°˜í™˜ í•œë‹¤.- ë§Œì•½ `atomicInteger` ì˜ ê°’ì´ í˜„ì¬ 0ì´ ì•„ë‹ˆë¼ë©´ `atomicInteger` ì˜ ê°’ì€ ë³€ê²½ë˜ì§€ ì•ŠëŠ”ë‹¤. ì´ ê²½ìš° `false` ë¥¼ ë°˜í™˜í•œë‹¤.-  **ì´ ë©”ì„œë“œëŠ” ì›ìì ìœ¼ë¡œ ì‹¤í–‰**ëœë‹¤ëŠ” ì ì´ë‹¤. - ì´ ë©”ì„œë“œê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ì´ ë°”ë¡œ `CAS(compareAndSet) ì—°ì‚°`ì´ë‹¤.<br/>## âš¡ï¸ CAS ì‹¤í–‰ ìˆœì„œ ë¶„ì„<img width="500" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-09-12 á„‹á…©á„’á…® 11 37 34" src="https://github.com/user-attachments/assets/20e3c268-8cd5-491b-93f9-458cf994e8fc">**ì´ ëª…ë ¹ì–´ëŠ” 2ê°œë¡œ ë‚˜ëˆ„ì–´ì§„ ëª…ë ¹ì–´ì´ë‹¤. ë”°ë¼ì„œ ì›ìì ì´ì§€ ì•Šì€ ì—°ì‚°ì²˜ëŸ¼ ë³´ì¸ë‹¤.**    1. ë¨¼ì € ë©”ì¸ ë©”ëª¨ë¦¬ì— ìˆëŠ” ê°’ì„ í™•ì¸í•œë‹¤.2. í•´ë‹¹ ê°’ì´ ê¸°ëŒ€í•˜ëŠ” ê°’(0)ì´ë¼ë©´ ì›í•˜ëŠ” ê°’(1)ìœ¼ë¡œ ë³€ê²½í•œë‹¤.> <u>**CPU í•˜ë“œì›¨ì–´ì˜ ì§€ì›**</u>: CPU í•˜ë“œì›¨ì–´ ì°¨ì›ì—ì„œ **íŠ¹ë³„í•˜ê²Œ í•˜ë‚˜ì˜ ì›ìì ì¸ ì—°ì‚°ìœ¼ë¡œ ë¬¶ì–´ì„œ ì œê³µ**í•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤.- ***`CPU`ëŠ” ë‘ ê³¼ì •ì„ í•˜ë‚˜ì˜ ì›ìì ì¸ ëª…ë ¹ìœ¼ë¡œ ë§Œë“¤ê¸° ìœ„í•´ 1ë²ˆê³¼ 2ë²ˆ ì‚¬ì´ì— ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ `x001` ì˜ ê°’ì„ ë³€ê²½í•˜ì§€ ëª»í•˜ê²Œ ë§‰ëŠ”ë‹¤.***- 1ë²ˆê³¼ 2ë²ˆ ì‚¬ì´ì˜ ì‹œê°„ì€ CPU ì…ì¥ì—ì„œ ë³´ë©´ **ì•„ì£¼ ì ê¹ ì°°ë‚˜ì˜ ìˆœê°„**ì´ë‹¤. **ê·¸ë˜ì„œ ì„±ëŠ¥ì— í° ì˜í–¥ì„ ë¼ì¹˜ì§€ ì•ŠëŠ”ë‹¤.**