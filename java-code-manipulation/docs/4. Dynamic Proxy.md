# 4. Dynamic Proxy<br/>## ëª©ì°¨- Spring Data JPA ëŠ” ì–´ë–»ê²Œ ë™ì‘í• ê¹Œ?- í”„ë¡ì‹œ íŒ¨í„´(Proxy Pattern)- Java ì—ì„œ ì œê³µí•˜ëŠ” Dynamic Proxy- í´ë˜ìŠ¤ì˜ Proxy- <br/><br/><br/># ğŸ’¡ Spring Data JPA ëŠ” ì–´ë–»ê²Œ ë™ì‘í• ê¹Œ?## âš¡ï¸ ìŠ¤í”„ë§ ë°ì´í„° JPA ì—ì„œ ì¸í„°í˜ì´ìŠ¤ íƒ€ì…ì˜ ì¸ìŠ¤í„´ìŠ¤ëŠ” ëˆ„ê°€ ì–´ë–»ê²Œ ë§Œë“¤ì–´ì£¼ëŠ” ê²ƒì¼ê¹Œ?```javaimport org.springframework.data.jpa.repository.JpaRepository;public interface SampleRepository extends JpaRepository<Sample, Long> {}``````java@SpringBootTestclass SampleServiceTest {    @Autowired SampleRepository sampleRepository;    @Test    public void di_test() {        Assertions.assertNotNull(sampleRepository);    }}```- ìš°ë¦¬ëŠ” @Repository annotation ì´ë‚˜ ê¸°íƒ€ ë‹¤ë¥¸ ì–´ë…¸í…Œì´ì…˜ì´ ì—†ëŠ” JPARepository ë¥¼ extend í•˜ì—¬ ì¸í„°í˜ì´ìŠ¤ ë‚´ë¶€ì˜ í•¨ìˆ˜ë“¤ì„ ìœ ìš©í•˜ê²Œ ì‚¬ìš©í•˜ê³  ìˆë‹¤.- interface ì¸ë° ì´ê²Œ ì–´ë–»ê²Œ instance ê°€ ë§Œë“¤ì–´ì¡Œì„ê¹Œ?- í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ë©´ ì‹¤ì œë¡œ query ê°€ ë‚ ë¼ê°€ëŠ” ê²ƒì„ ë³¼ ìˆ˜ê°€ ìˆë‹¤. êµ¬í˜„ì²´ê°€ ë§Œë“¤ì–´ì§„ ê²ƒì´ë‹¤.## âš¡ï¸ ì •ë‹µì€ Proxy```javapackage org.springframework.aop.framework;import org.aopalliance.intercept.Interceptor;import org.springframework.aop.TargetSource;import org.springframework.lang.Nullable;import org.springframework.util.ClassUtils;/** * Factory for AOP proxies for programmatic use, rather than via declarative * setup in a bean factory. This class provides a simple way of obtaining * and configuring AOP proxy instances in custom user code. */@SuppressWarnings("serial")public class ProxyFactory extends ProxyCreatorSupport {}``````javapublic abstract class RepositoryFactorySupport implements BeanClassLoaderAware, BeanFactoryAware {    public <T> T getRepository(Class<T> repositoryInterface, RepositoryFragments fragments) {        ...        // Create proxy        StartupStep repositoryProxyStep = onEvent(applicationStartup,            "spring.data.repository.proxy", repositoryInterface);        ProxyFactory result = new ProxyFactory();        result.setTarget(target);        result.setInterfaces(repositoryInterface, Repository.class, TransactionalProxy.class);        ...        return repository;    }}```- Spring Data JPA ì—ì„œëŠ” Spring AOP ë¥¼ ì‚¬ìš©í•˜ê³ , `Spring AOP` ëŠ” `RepositoryFactorySupport` ë¥¼ ì‚¬ìš©í•œë‹¤.- ì´ê²ƒì´ Java ì—ì„œ ì¶”ìƒí™”í•´ë†“ì€ Spring AOP í•µì‹¬ í´ë˜ìŠ¤ì´ê³ , Spring Data JPA ì—ì„œëŠ” ì´ê²ƒì„ ì‚¬ìš©í•œë‹¤.- `Spring AOP` ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘í•˜ë©° `RepositoryFactorySupport` ì—ì„œ `ProxyFactory` í´ë˜ìŠ¤ë¥¼ í†µí•´ Proxy ê°ì²´ë¥¼ ë§Œë“ ë‹¤.- ì—¬ê¸°ì„œ ë§Œë“¤ì–´ì£¼ëŠ” í”„ë¡ì‹œ ê°ì²´ê°€ bean ìœ¼ë¡œ ë“±ë¡ì´ ë˜ì–´ì„œ ìš°ë¦¬ê°€ ë§Œë“  application ì— `@Autowired` ëœ Repository ë“¤ì—ê²Œ ì£¼ì…ëœë‹¤.<br/><br/><br/># ğŸ’¡ í”„ë¡ì‹œ íŒ¨í„´(Proxy Pattern)<img width="769" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-07-16 á„‹á…©á„’á…® 5 00 28" src="https://github.com/user-attachments/assets/4fd26a4b-734b-4061-b0f5-086a5e8a2218"><img width="352" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-07-16 á„‹á…©á„’á…® 5 10 09" src="https://github.com/user-attachments/assets/2b033508-595a-42a5-9ebd-2ac73492b64e">**í”„ë¡ì‹œ íŒ¨í„´ì€ ìœ„ì™€ ê°™ì´ êµ¬ì„±ëœë‹¤.**- Proxy í´ë˜ìŠ¤ì™€ RealSubject í´ë˜ìŠ¤ê°€ ê³µí†µì˜ ë¶€ëª¨ë¡œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ê°€ì§€ê³  ìˆë‹¤. - í´ë¼ì´ì–¸íŠ¸ëŠ” ì¸í„°í˜ì´ìŠ¤ íƒ€ì…, Proxy ë¥¼ ê±°ì³ RealSubject ì— ì ‘ê·¼í•œë‹¤. - ì¦‰, Client -> Interface -> Proxy -> RealSubject ìˆœì„œë¡œ ì ‘ê·¼í•œë‹¤.RealSubject ì— ì ‘ê·¼í•  í•„ìš”ê°€ ì—†ì„ ë•Œì—ëŠ” Proxy ì—ì„œ ë°”ë¡œ ë¦¬í„´í•˜ê¸°ë„ í•œë‹¤.## âš¡ï¸ ì¥ì - RealSubject ì—ì„œëŠ” ê·¸ê°€ ë§¡ì€ ë‹¨ì¼ ì±…ì„ì—ë§Œ ì§‘ì¤‘í•˜ë©´ ëœë‹¤. (SRP)  - ë³¸ì¸ì´ ê°€ì§„ ì—­í•  ì´ì™¸ì—ëŠ” ì¶”ê°€ê°€ ë˜ë©´ ì•ˆëœë‹¤.   - í•˜ë‚˜ì˜ í´ë˜ìŠ¤ëŠ” í•˜ë‚˜ì˜ ì—­í• ë§Œ í•´ì•¼í•œë‹¤. ë‹¤ë¥¸ ì—­í• ì„ í•˜ëŠ”ê²ƒì„ ì¶”ê°€í• ë• í•´ë‹¹ í´ë˜ìŠ¤ê°€ ìˆ˜ì •ì´ ë˜ì–´ì„  ì•ˆëœë‹¤.   - ë¡œê¹… ê¸°ëŠ¥ì„ ì¶”ê°€í•œë‹¤ë˜ê°€, ê¶Œí•œ ì²´í¬ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ëŠ” ë“± ì˜ ê²½ìš°ì— ë¦¬ì–¼ ì„œë¸Œì íŠ¸ë¥¼ ì§ì ‘ ìˆ˜ì •í•´ì„œ ì•ˆëœë‹¤.Proxy ì—ì„œëŠ” RealSubject ì— í•„ìš”í•œ ì ‘ê·¼ì œí•œ, ë¡œê¹…, íŠ¸ëœì­ì…˜ ë“± ë¶€ê°€ì ì¸ ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤. ## âš¡ï¸ í”„ë¡ì‹œ íŒ¨í„´ êµ¬í˜„ ì˜ˆì‹œ```javapublic interface SampleService {    void test(Sample sample);}public class DefaultSampleService implements SampleService {    public void test(Sample sample) {        System.out.println("SampleService.test(): " + sample.getName());    }}public class SampleServiceProxy implements SampleService {    SampleService sampleService;    public SampleServiceProxy(SampleService sampleService) {        this.sampleService = sampleService;    }    @Override    public void test(Sample sample) {        System.out.println("proxy ê°ì²´ì—ì„œ ë³€ê²½í•˜ê³  ì‹¶ì€ ì‚¬í•­ë“¤ì„ ì—¬ê¸°ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");        sampleService.test(sample);    }}``````javaclass SampleServiceTest {    SampleService sampleService = new SampleServiceProxy(new DefaultSampleService());    @Test    public void di_test() {        Sample sample = new Sample();        sample.setName("spring");        sampleService.test(sample);    }}```## âš¡ï¸ ì§ì ‘ êµ¬í˜„ì˜ ë¬¸ì œì - ì¼ë°˜ì ì¸ í”„ë¡ì‹œ íŒ¨í„´ì„ ì´ìš©í•˜ê²Œ ë˜ë©´, ê° ì„œë¹„ìŠ¤ë§ˆë‹¤ ê·¸ì— í•´ë‹¹í•˜ëŠ” í”„ë¡ì‹œê°€ í•˜ë‚˜ì”© ìƒì„±ë˜ì–´, ë„ˆë¬´ ë§ì€ í´ë˜ìŠ¤ê°€ ìƒì„±ë˜ê³ , ê·¸ ë‚´ë¶€ì˜ ì½”ë“œë„ ì¤‘ë³µëœë‹¤ëŠ” ë¬¸ì œì ì´ ë°œìƒí•˜ê²Œ ëœë‹¤.- ì´ë¥¼ íš¨ê³¼ì ìœ¼ë¡œ í•´ê²°í•˜ê¸° ìœ„í•´ `Reflection API` ì—ì„œëŠ” `Dynamic Proxy` ë¼ëŠ” ê°œë…ì„ ì§€ì›í•œë‹¤.- `Dynamic Proxy` ë¥¼ ì´ìš©í•´ì„œ ì»´íŒŒì¼ íƒ€ì„ì— ë¯¸ë¦¬ ë§Œë“¤ì–´ì§„ í´ë˜ìŠ¤ê°€ ì•„ë‹ˆë¼, **`Runtime` ì— ìœ ë™ì ìœ¼ë¡œ í´ë˜ìŠ¤ íƒ€ì…ì— ë§ëŠ” í”„ë¡ì‹œ ê°ì²´ë¥¼ ë§Œë“¤ìˆ˜ ìˆë‹¤.**## ì°¸ê³ - https://www.oodesign.com/proxy-pattern.html- https://ko.wikipedia.org/wiki/%ED%94%84%EB%A1%9D%EC%8B%9C_%ED%8C%A8%ED%84%B4- https://en.wikipedia.org/wiki/Proxy_pattern- https://en.wikipedia.org/wiki/Single_responsibility_principle- https://wiki.mhson.world/java-spring/java/undefined-4<br/><br/><br/># Java ì—ì„œ ì œê³µí•˜ëŠ” Dynamic Proxy> **Java ì—ì„œëŠ”** > > ë§¤ë²ˆ í”„ë¡ì‹œ ë””ìì¸ íŒ¨í„´ì„ êµ¬í˜„í•˜ì—¬, íƒ€ì…ì— ë§ëŠ” í”„ë¡ì‹œ í´ë˜ìŠ¤ë¥¼ ìƒì„±í•˜ëŠ” ë°©ì‹ì´ ì•„ë‹ˆë¼, ëŸ°íƒ€ì„ì— ë™ì ìœ¼ë¡œ í´ë˜ìŠ¤ íƒ€ì…ì— ë§ëŠ” í”„ë¡ì‹œ ê°ì²´ë¥¼ ìƒì„±í•œë‹¤.## âš¡ï¸ êµ¬í˜„```javapublic class ProxyServiceTest {    SampleService bookService = (SampleService) Proxy.newProxyInstance(SampleService.class.getClassLoader(), new Class[]{SampleService.class},        new InvocationHandler() {            SampleService bookService = new DefaultSampleService();            @Override            public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {                if (method.getName().equals("test")) {                    System.out.println("aaaa");                    Object invoke = method.invoke(bookService, args);                    System.out.println("bbbb");                    return invoke;                }                return method.invoke(bookService, args); }        });    @Test    void proxy_test() {        Sample sample = new Sample();        sample.setName("spring");        bookService.test(sample);    }}```## Java ì—ì„œ ì œê³µí•˜ëŠ” Dynamic Proxy ì˜ ë¬¸ì œì 1. Java ì—ì„œ ì œê³µí•´ì£¼ëŠ” dynamic proxy ëŠ” ëª¨ë“  ë§¤ì†Œë“œì— ì¼ê´„ì ìœ¼ë¡œ ì ìš©ë˜ë©° ì¼ë¶€ ë§¤ì†Œë“œì—ë§Œ ì ìš©í•˜ê³  ì‹¶ì„ ë•Œì—ëŠ” ìœ„ì˜ ì½”ë“œì²˜ëŸ¼ if ë¶„ê¸°ë¥¼ í•´ì£¼ì–´ ìˆ˜ë™ì ìœ¼ë¡œ ì„¤ì •í•´ì•¼í•œë‹¤. í™•ì¥ì„±ì´ ë§¤ìš° ì•ˆì¢‹ê³  ìœ ì—°í•˜ì§€ ëª»í•œ êµ¬ì¡°ë¼ê³  í•  ìˆ˜ ìˆë‹¤.   - ê·¸ë˜ì„œ ìŠ¤í”„ë§ AOP ê°€ ë“±ì¥í•˜ê²Œ ë˜ì—ˆë‹¤.2. ì¸í„°í˜ì´ìŠ¤ íƒ€ì…ì˜ í”„ë¡ì‹œë§Œ ì œê³µí•˜ì§€, í´ë˜ìŠ¤ íƒ€ì…ì˜ í”„ë¡ì‹œëŠ” ì œê³µí•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì ì´ë‹¤.  - í´ë˜ìŠ¤ì˜ ê²½ìš°ì—ëŠ” Java ì—ì„œ ì œê³µí•˜ëŠ” Dynamic Proxy ëŠ” ì‚¬ìš©í•˜ì§€ ëª»í•œë‹¤.  - í´ë˜ìŠ¤ì˜ ê²½ìš°ì—ëŠ” CGLIB ë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡ì‹œë¥¼ ìƒì„±í•œë‹¤.## ì°¸ê³ - https://docs.oracle.com/javase/8/docs/technotes/guides/reflection/proxy.html- https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Proxy.html#newProxyInstance-java.lang.ClassLoader-java.lang.Class:A-java.lang.reflect.InvocationHandler-<br/><br/><br/># ğŸ’¡ í´ë˜ìŠ¤ì˜ Proxy